@using Wfm.Domain.Services.FileSystem

@model Wfm.Domain.Features.FileManager.GetFiles.GetFilesResult

@{
    ViewData["Title"] = "Files";

    string FormatBytes(long bytes)
    {
        string[] suffixes = { "B", "KB", "MB", "GB", "TB", "PB", "EB" };
        int i = 0;
        double dblBytes = bytes;

        if (bytes > 1024)
        {
            for (i = 0; (bytes / 1024) > 0; i++, bytes /= 1024)
            {
                dblBytes = bytes / 1024.0;
            }
        }
        
        return String.Format("{0:0.##} {1}", dblBytes, suffixes[i]);
    }

    List<KeyValuePair<string, string>> ConvertPathToList(string path)
    {
        var result = new List<KeyValuePair<string, string>>();

        if (string.IsNullOrEmpty(path))
            return result;

        string[] directories = path.Split('/', '\\');
        string currentPath = "";

        for (int i = 0; i < directories.Length; i++)
        {
            currentPath += (i == 0 ? "" : "/") + directories[i];
            result.Add(new KeyValuePair<string, string>(directories[i], currentPath));
        }

        return result;
    }
}

<hgroup>
    <p>
        @if (ViewBag.BackPath != null)
        {
            @Html.ActionLink("Back", "Index", "Files", new { LocationIndex = Model.LocationIndex, RelativePath = ViewBag.BackPath })
        }
    </p>
</hgroup>

<nav aria-label="breadcrumb">
    <ul>
        <li>@Html.ActionLink("Home", "Index", "Home")</li>
        <li>@Html.ActionLink(ViewBag.LocationName as string, "Index", "Files", new { LocationIndex = Model.LocationIndex })</li>
        @foreach (KeyValuePair<string, string> item in ConvertPathToList(Model.RelativePath))
        {
            <li>@Html.ActionLink(item.Key, "Index", "Files", new { LocationIndex = Model.LocationIndex, RelativePath = item.Value })</li>
        }
    </ul>
</nav>

<figure>
    <table role="grid">
        <thead>
            <tr>
                <th>Name</th>
                <th>Modified</th>
                <th>Type</th>
                <th>Size</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var entry in Model.Entries)
            {
                <tr>
                    <td>

                        @if (entry.Type == FileSystemEntryType.Directory)
                        {
                            @Html.ActionLink(entry.Name, "Index", "Files", new { LocationIndex = Model.LocationIndex, RelativePath = entry.RelativePath })
                        }
                        else
                        {
                            @entry.Name
                        }
                    </td>
                    <td>@entry.ModifiedDate</td>
                    <td>@entry.Extension.ToUpper()</td>
                    <td>
                        @if (entry.Type == FileSystemEntryType.File && entry.Size > 0)
                        {
                            @FormatBytes(entry.Size)
                        }
                    </td>
                    <td>
                        @if (entry.Type == FileSystemEntryType.File)
                        {
                            @Html.ActionLink("Preview", "Preview", "Files", new { LocationIndex = Model.LocationIndex, RelativeFilePath = entry.RelativePath })
                            <text> | </text>
                            @Html.ActionLink("Download", "Download", "Files", new { LocationIndex = Model.LocationIndex, RelativeFilePath = entry.RelativePath })
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</figure>
